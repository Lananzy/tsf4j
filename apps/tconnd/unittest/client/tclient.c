/*
**  @file $RCSfile: tclient.c,v $
**  general description of this module
**  $Id: tclient.c,v 1.6 2009/04/01 10:18:57 hardway Exp $
**  @author $Author: hardway $
**  @date $Date: 2009/04/01 10:18:57 $
**  @version $Revision: 1.6 $
**  @note Editor: Vim 6.1, Gcc 4.0.1, tab=4
**  @note Platform: Linux
*/
#include "tclient.h"


static TAPPCTX gs_stAppCtx={-1, 0, 0, 0, 0, 0, 0};
static TClientEnv gs_stClientEnv;
extern unsigned char g_szMetalib_client_def[];
extern unsigned char g_szMetalib_CSPKG[];

//2048 'a'
static unsigned char g_szpadding[]={\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
	0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,\
       0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61,0x61};

int tclient_init_qqapi(TClientEnv* pstEnv,TClientInst *pstClientInst)
{
    int iRet=0;
    int s=0;

    s=tqqapi_open(pstEnv->pstConf->szGameSvrUrl, CONNTIMEOUT,&pstClientInst->hqqapi);
	
   if(s<0)
   {
           tlog_error(pstEnv->pstLog, 0, 0, "Connect to server=%s timeout=%d\n",pstEnv->pstConf->szGameSvrUrl,CONNTIMEOUT);
           return -1;
   }
  
    iRet=tqqapi_set_pdu_meta(pstClientInst->hqqapi, pstEnv->pstMeta, pstEnv->pstMeta);

   if(iRet<0)
   {
           tlog_error(pstEnv->pstLog, 0, 0, "Set QQAPI PDU Meta failed!\n");
	    tqqapi_free(&pstClientInst->hqqapi);
           return -1;
   }
   
   iRet=tqqapi_create_initial_connection(pstClientInst->hqqapi, pstEnv->pstConf->iUin, pstEnv->pstConf->szSvrKey, pstEnv->pstConf->iAuthType, RECVTIMEOUT);
   if(iRet<0)
   {
           tlog_error(pstEnv->pstLog,0,0,"Error Code=%d,Errorstring=%s,iRet=%d,syserrorstring=%s\n",tqqapi_get_err(pstClientInst->hqqapi),tqqapi_get_errstring(pstClientInst->hqqapi),iRet,strerror(errno));
	    tqqapi_free(&pstClientInst->hqqapi);	   
	    return -1;
   }
   

   iRet=tqqapi_set_recvbuff(pstClientInst->hqqapi,RECVBUFF);
   if(iRet<0)
   {
           tlog_error(pstEnv->pstLog, 0, 0, "Set QQAPI recv buffer failed!\n");
	    tqqapi_free(&pstClientInst->hqqapi);
           return -1;
   }
   

   iRet=tqqapi_set_sendbuff(pstClientInst->hqqapi,SENDBUFF);
   if(iRet<0)
   {
           tlog_error(pstEnv->pstLog, 0, 0, "Set QQAPI send buffer failed!\n");
	    tqqapi_free(&pstClientInst->hqqapi);
           return -1;
   }
   
   //tlog_info(pstEnv->pstLog, 0, 0, "Connect Time=%d Milli Second\n",nConnectTime);
   return 0;

}


int tclient_init(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
	int iRet=0;
       LPTDRMETALIB plib=NULL;
	int iOnlineCount=0;
	int iMaxOnline=0;

	//get log category
       pstEnv->pstLog	=	NULL;
	tapp_get_category(NULL, (int*)&pstEnv->pstLog);
	if(!pstEnv->pstLog)
	{
             printf("error: can not get log category.\n");
	      return -1;

	}
       pstEnv->iSlipCount =	0;
	if( !pstAppCtx->iTimer ||
	     (0 !=	(1000%(pstAppCtx->iTimer))) )
	{
	      printf("error:Timer value is invalid\n");
	      return -1;		
	}
	else
	{
            pstEnv->iSlipCount =  1000/(pstAppCtx->iTimer);

	}
	

	if( pstEnv->iSlipCount<=0 )
	{
             printf("error:Timer value is too long\n");
	      return -1;
	}
		
       pstEnv->iSpeedFactor=1;
	

	//get config meta and data
	if( !(LPTDRMETA)pstAppCtx->stConfData.iMeta || !pstAppCtx->stConfData.pszBuff)
	{
		printf("error: do not specify config meta.\n");
		return -1;
	}

       pstEnv->pstConf=(LPCLIENT_DEF)pstAppCtx->stConfData.pszBuff;
	 
       if(!pstEnv->pstConf)
       {
              printf("error:do not specify config data\n");
		return -1;
	}
	

       //get protocol meta
       plib=(LPTDRMETALIB)g_szMetalib_CSPKG;
       pstEnv->pstMeta=tdr_get_meta_by_name(plib,METANAME);
	if(!pstEnv->pstMeta)
	{
             printf("error: can not get  pdu meta.\n");
	      return -1;
	}

	//init client pool
	iRet=tmempool_new(&pstEnv->pstClientPool, MAX_EPOLL_EVENTS, sizeof(TClientInst));
	if(iRet!=0)
	{
            printf("error:init client pool failed\n");
	     return -1;
	}

	pstEnv->iepfd=epoll_create(MAX_EPOLL_EVENTS);
	if(pstEnv->iepfd<0)
	{
           printf("error:create epoll failed,errorstring=%s\n",strerror(errno));
	    return -1;
	}
	
       if( pstEnv->iPackageSize < MIN_SIZE)
       {
            pstEnv->iPackageSize = MIN_SIZE;		
	}
	else if( pstEnv->iPackageSize >  MAX_SIZE)
	{        
            pstEnv->iPackageSize=MAX_SIZE;
	}

	if( pstEnv->iMaxOnline < MIN_ONLINE)
	{
	    pstEnv->iMaxOnline = MIN_ONLINE;
	}
	else if( pstEnv->iMaxOnline > MAX_ONLINE)
	{
           pstEnv->iMaxOnline = MAX_ONLINE;
	}

	if( pstEnv->iMaxSpeed< MIN_SPEED)
	{
	    pstEnv->iMaxSpeed = MIN_SPEED;
	}
	else if( pstEnv->iMaxSpeed > MAX_SPEED)
	{
           pstEnv->iMaxSpeed = MAX_SPEED;
	}

	//login in MAX_ONLINE people
	iOnlineCount=0;

	tlog_info(pstEnv->pstLog, 0, 0, "total play=%d begin to login in,it will takes some time..please wait!\n",pstEnv->iMaxOnline );	 
	
	while( iOnlineCount <  pstEnv->iMaxOnline)
	{
           iRet=tclient_login_player(pstAppCtx,pstEnv);
	     if(iRet!=0)
	    {
                tlog_error(pstEnv->pstLog, 0, 0,"login the %d Online failed=%d,retry\n",iOnlineCount);
		  continue;		
	    }
	    iOnlineCount++;
	}
	
			
	tlog_info(pstEnv->pstLog, 0, 0, "login in finished!totol online=%d,init success\n",iOnlineCount);	 
	return 0;
}


int tclient_fini(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
	
	int iScanPos=0;
	TClientInst *pInst;
	
	for(iScanPos=0;iScanPos<TMEMPOOL_GET_CAP(pstEnv->pstClientPool);iScanPos++)
	{
          pInst=(TClientInst *)tmempool_get(pstEnv->pstClientPool,iScanPos );
	   if(!pInst)
	   {
               continue;			   
	   }
          tqqapi_free(&pInst->hqqapi);	   
	}

	tmempool_destroy(&pstEnv->pstClientPool);
	return 0;
}

int tclient_tick(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
	int iSendSpeed=0;
	int iRecvSpeed=0;
	int iCurSendSpeed=0;
	int iCurRecvSpeed=0;
	static int iCount1=0;
	 int iSpeedFactor=0;
	 int i=0;

	tclient_proc_send(pstAppCtx,pstEnv);

	iCount1++;

	//output info every 10 seconds
	if((iCount1%(10*pstEnv->iSlipCount))== 0)
	{
            iCount1=0;
	     iSendSpeed=(pstEnv->iTotalSendSucc-pstEnv->iLastSendSucc)/10;
	     iRecvSpeed=(pstEnv->iTotalRecvSucc-pstEnv->iLastRecvSucc)/10;
	     if( pstEnv->iSpeedFactor<pstEnv->iMaxSpeed)
	     {
                  pstEnv->iSpeedFactor++;
	     }
	     
            tlog_info(pstEnv->pstLog,0, 0, "Total Send=%d,Total Recv=%d,Current SendSpeed=%d:Current RecvSpeed=%d\n",
		                                            pstEnv->iTotalSendSucc,pstEnv->iTotalRecvSucc,
		                                            iSendSpeed,iRecvSpeed);
	    pstEnv->iLastSendSucc=pstEnv->iTotalSendSucc;
	    pstEnv->iLastRecvSucc=pstEnv->iTotalRecvSucc;
			
	}

	
	
	return 0;
}



int tclient_proc(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{

	return tclient_proc_recv(pstAppCtx,pstEnv);
     
}

int tclient_proc_recv(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
      int iRet=0;
      struct epoll_event events[MAX_EPOLL_EVENTS];
      int iEvents;
      int i=0;
      TClientInst *pstInst;

      iEvents	=	epoll_wait(pstEnv->iepfd, events, MAX_EPOLL_EVENTS, pstAppCtx->iEpollWait);

	if(iEvents<0)
	{
              tlog_error(pstEnv->pstLog, 0, 0,"epoll_wait error errostring=%s\n", strerror(errno));
		return -1;
	}
	else if(iEvents==0)
	{
              return -1;
	}

	for(i=0;i<iEvents;i++)
	{
             pstInst	= tmempool_get(pstEnv->pstClientPool, events[i].data.fd);
			 
		/* bad packet. */
		if( !pstInst )
		{
			epoll_ctl(pstEnv->iepfd, EPOLL_CTL_DEL, (&events[i].data.fd)[1], events+i);
			tlog_error(pstEnv->pstLog, 0, 0,"pstInst not find, idx=%d\n", events[i].data.fd);
			continue;
		}

		tclient_proc_recv_packge(pstEnv,pstInst);
	
	}

	return 0;
}



int tclient_proc_recv_packge(TClientEnv* pstEnv,TClientInst *pstClientInst)
{
      int iRet=0;
      int iMsgBuf=0;

       while(1)
      {
              iMsgBuf=sizeof(pstClientInst->stRecvPDU);
		iRet=tqqapi_recv_msg(pstClientInst->hqqapi,& pstClientInst->stHead,(char *)&pstClientInst->stRecvPDU,&iMsgBuf, 0);
		 if(iRet<0)
		 {
		       tlog_error(pstEnv->pstLog, 0, 0, "QQapi Recv package failed!iD=%d,error=%d,errorstring=%s,errno=%d,syserrorstring=%s\n",pstClientInst->iID,tqqapi_get_err(pstClientInst->hqqapi),tqqapi_get_errstring(pstClientInst->hqqapi),errno,strerror(errno));
		       return -1; 
		 }
		 else if(iRet == 0)
		 {
		       //recv no package
		    return 0;
		 }

		 //recv one packge
		   pstEnv->iTotalRecvSucc++;


		  //deal with package head
		  switch(pstClientInst->stHead.stBase.bCmd)
		  {
		       case TPDU_CMD_STOP:
		            //connection free by server			   	
		            //to do
		           break;
		    default:
			     break;
		}

		 //deal with package body:msg
		 switch( pstClientInst->stRecvPDU.stHead.wCmd)
		 {
		    case CMD_HELLO:
			   	break;
		    case CMD_LOGIN:
		    case CMD_LOGOUT:
		    default:
				tlog_error(pstEnv->pstLog, 0, 0, "Undeal with Msg,CMD=%d\n",pstClientInst->stRecvPDU.stHead.wCmd);
				break;
		 }
		 
	}
    	

     return 1;
}

int tclient_proc_send(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
      int iRet=0;
      int iScanPos=0;
      TClientInst *pstInst=NULL;
       int i=0;
	int iSendPackage=0;
	int iSlipNum=0;

	

	pstEnv->iSlipPos++;

	iSlipNum=pstEnv->iSlipPos%pstEnv->iSlipCount;


	
      //if the last time slip
	if( 0== iSlipNum)
	{
             iSendPackage = pstEnv->iSpeedFactor%pstEnv->iSlipCount+pstEnv->iSpeedFactor/pstEnv->iSlipCount;

	}
	else
	{
            iSendPackage = pstEnv->iSpeedFactor/pstEnv->iSlipCount;

	}

	if( 0 == iSendPackage)
	{
             return 0;
	}
	
	

      for(iScanPos=0;iScanPos<TMEMPOOL_GET_CAP(pstEnv->pstClientPool);iScanPos++)
      {
          pstInst=(TClientInst *)tmempool_get(pstEnv->pstClientPool,iScanPos );
	   if(!pstInst)
	   {
               continue;			   
	   }
	   //every player send  every speed factor packge one time
	   
	   for( i=0;i<iSendPackage;i++)
	   {
               iRet=tclient_proc_send_packge(pstEnv,pstInst);
	        if(iRet)
	        {
                     break;
		  }

	   }   
	}
  
      return 0;
}




int tclient_proc_send_packge(TClientEnv* pstEnv,TClientInst *pstClientInst)
{
     int iRet=0;
     int iDataSize=0;
     char achar='a';
	 
     iDataSize=pstEnv->iPackageSize-32;
     pstClientInst->stSendPDU.stHead.wCmd=CMD_HELLO;
     pstClientInst->stSendPDU.stHead.wVersion=0;
     pstClientInst->stSendPDU.stBody.stHello.iUin=pstEnv->pstConf->iUin;
     memcpy( pstClientInst->stSendPDU.stBody.stHello.szData,(char *)g_szpadding,iDataSize-1);
     pstClientInst->stSendPDU.stBody.stHello.szData[iDataSize]=0;	 

    iRet=tqqapi_send_msg(pstClientInst->hqqapi, NULL, &pstClientInst->stSendPDU, sizeof(pstClientInst->stSendPDU), INTERVAL);
    if(iRet<0)
    {
    	  printf("send packge failed,iD=%derror=%d,errorstring=%s,syserrno=%d,syserrorstring=%s\n",pstClientInst->iID,tqqapi_get_err(pstClientInst->hqqapi),tqqapi_get_errstring(pstClientInst->hqqapi),errno,strerror(errno));
         tlog_error(pstEnv->pstLog, 0, 0, "send packge failed,iD=%derror=%d,errorstring=%s,syserrno=%d,syserrorstring=%s\n",pstClientInst->iID,tqqapi_get_err(pstClientInst->hqqapi),tqqapi_get_errstring(pstClientInst->hqqapi),errno,strerror(errno));
	  return -1;     
    }
	
    pstEnv->iTotalSendSucc++;
    return 0;	 
}

int tclient_login_player(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
    int iRet=0;
    LPTClientInst pClientInst=NULL;
    epoll_event_t e;
     int s=-1;

    int iID=tmempool_alloc(pstEnv->pstClientPool);

    if(iID<0)
    {
         tlog_error(pstEnv->pstLog,0,0,"allocate the %d  player buffer failed\n",pstEnv->pstClientPool->iUsed);
	  return -1;
    }

    pClientInst=tmempool_get(pstEnv->pstClientPool, iID);
    if(!pClientInst)
    {
         tlog_error(pstEnv->pstLog,0,0,"get the %d  player buffer failed\n",pstEnv->pstClientPool->iUsed);
	  return -1;
    }
    pClientInst->iID=iID;

    iRet=tclient_init_qqapi(pstEnv,pClientInst);
    if(iRet!=0)
    {
         tlog_error(pstEnv->pstLog,0,0," the %d  player login failed\n",pstEnv->pstClientPool->iUsed);
	  tmempool_free(pstEnv->pstClientPool, iID);
	  return -1;	 
    }

    e.events	=	EPOLLIN;
    e.data.fd	=	iID;
    s=tqqapi_get_sock(pClientInst->hqqapi);
    (&e.data.fd)[1]	=s;
	
    iRet=epoll_ctl(pstEnv->iepfd,EPOLL_CTL_ADD,s,&e);
    if(iRet<0)
    {
         tlog_error(pstEnv->pstLog,0,0,"add  the %d  player to epoll failed\n",pstEnv->pstClientPool->iUsed);
	  tqqapi_free(pClientInst->hqqapi);
	  tmempool_free(pstEnv->pstClientPool, iID);
	  return -1;	
    }
   
    return 0;
}



int tclient_def_opt(TAPPCTX* pstAppCtx, TClientEnv* pstEnv)
{
      int opt;
      int iOldOptErr;
      static struct option s_astLongOptions[] = {
		{"online", 1, NULL, 'o'},
		{"package",1,NULL,'p'},
		{"max-speed",1,NULL,'s'},
		{0, 0, 0, 0}
	};

	assert(NULL != pstEnv);
	assert(0 < pstAppCtx->argc);
	assert(NULL != pstAppCtx->argv);

	iOldOptErr	=	opterr;
	opterr	=	0;	
	while (1)
	{
		int option_index = 0;
		
		opt = getopt_long (pstAppCtx->argc, pstAppCtx->argv, "ops:",
			s_astLongOptions, &option_index);

		if (opt == -1)
			break;
		
		switch(opt)
		{
		case 'o':
			pstEnv->iMaxOnline= atoi(optarg);
			break;
		case 'p':
			pstEnv->iPackageSize=atoi(optarg);
			break;	
		case 's':
			pstEnv->iMaxSpeed=atoi(optarg);
		default:
			break;
		}
	}/*while (1)*/


	/* restore the getopt environment. */
	opterr	=	iOldOptErr;
	optarg	=	NULL;	
	optind	=	1;	
	optopt	=	'?';

}


int main(int argc, char* argv[])
{
	int iRet;
	void* pvArg	=	&gs_stClientEnv;

	gs_stAppCtx.argc	=	argc;
	gs_stAppCtx.argv	=	argv;

 	gs_stAppCtx.iTimer	=	1000;
	gs_stAppCtx.pfnInit	=	(PFNTAPPFUNC)tclient_init;
	gs_stAppCtx.pfnFini	=	(PFNTAPPFUNC)tclient_fini;
	gs_stAppCtx.pfnProc	=	(PFNTAPPFUNC)tclient_proc;
	gs_stAppCtx.pfnTick	=	(PFNTAPPFUNC)tclient_tick;

	memset(&gs_stClientEnv, 0, sizeof(gs_stClientEnv));
	
       gs_stAppCtx.iLib=(int)g_szMetalib_client_def;

	tclient_def_opt(&gs_stAppCtx,&gs_stClientEnv);
	iRet	=	tapp_def_init(&gs_stAppCtx, pvArg);
	if( iRet<0 )
	{
		printf("Error: Initialization failed.\n");
		return iRet;
	}

	iRet	=	tapp_def_mainloop(&gs_stAppCtx, pvArg);

	tapp_def_fini(&gs_stAppCtx, pvArg);

	return iRet;
}



